<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Editor</title>
    <script src="https://cdn.jsdelivr.net/gh/wbojczuk/JSDevTools/jsdev.min.js"></script>
    <script src="/tinyEditor/js/tinymce/tinymce.min.js"></script>
</head>
<body>
    <label for="blogTitle">Title:</label><input type="text" name="blogTitle" id="blogTitle" placeholder="Blog Title"><br>
    <label for="blogTitle">Description:</label><input type="text" name="blogDescription" id="blogDescription" placeholder="Blog Description"><br>
    <label for="blogTags">Tags:</label><input type="text" placeholder="Add Tag">
    <div id="tagsContainer">

    </div>

    <textarea name="blogEditor" id="blogEditor" cols="30" rows="10"></textarea>

    <button id="submitButton">Submit</button>

    <script>

        tinymce.init({
            selector: "#blogEditor",
            plugins: 'image',
            toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | outdent indent| image',
            image_title: true,
            /* enable automatic uploads of images represented by blob or data URIs*/
            automatic_uploads: true,
            a11y_advanced_options: true,
            file_picker_types: 'image',

            file_picker_callback: function (cb, value, meta) {
            var input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');

    /*
      Note: In modern browsers input[type="file"] is functional without
      even adding it to the DOM, but that might not be the case in some older
      or quirky browsers like IE, so you might want to add it to the DOM
      just in case, and visually hide it. And do not forget do remove it
      once you do not need it anymore.
    */

    input.onchange = function () {
      var file = this.files[0];
      const formData = new FormData();
      formData.append("image", file)
      fetch("https://api.imgur.com/3/image", {
                method: "POST",
                headers: {
                    "Authorization": "Client-ID 7879aa609162d4c"
                },
                body: formData
            }).then((res)=>res.json()).then((data)=>{
                cb(`${data.data.link}`, {title: `${data.data.id}`});
            })
        /* call the callback and populate the Title field with the file name */
        // 
      };

    input.click();
  },
  setup: function(editor){
    editor.on("init", setOldData)
  }
        })

        async function setOldData(){
        
        // SET OLD DATA
        const GETVals = jsdev.GETValues();
        const blogFetchData = await fetch(`/api/blogs/id/${GETVals.blogid}`);
        const blogData = await blogFetchData.json();

        const blogFetchContent = await fetch(`/api/blogcontent/${GETVals.blogid}`);
        const blogContent = await blogFetchContent.text();

        // GET SELECTED TAGS
        const fetchData = await fetch("/api/blogs/categories");
        const categories = await fetchData.json();

        let tagHTML = "";
        let counter = 0;
        categories.forEach((category)=>{
            let isChecked = (blogData.tags.includes(category)) ? "checked" : "";
            tagHTML += `<input ${isChecked} type="checkbox" name="tag${counter}" id="tag${counter}"><label for="tag${counter}">${category}</label><br>`;
            ++counter;
        })
        document.getElementById("tagsContainer").innerHTML = tagHTML;


        document.getElementById("blogTitle").value = blogData.title;
        document.getElementById("blogDescription").value = blogData.description;
        tinymce.activeEditor.setContent(blogContent)

        // Submit button listener
        document.getElementById("submitButton").addEventListener("click", ()=>{
            tinymce.triggerSave();

            // Get Selected Tags
            const selectedTags = [];
            document.querySelectorAll("#tagsContainer input").forEach((checkbox)=>{
                if(checkbox.checked){
                    selectedTags.push(document.querySelector(`label[for="${checkbox.id}"]`).textContent.toLowerCase())
                }
            })


            fetch("/api/editblog", {method: "POST", headers:{"Content-Type": "application/json"},
                body: JSON.stringify({
                    id: blogData.id,
                    // UPDATE TO ACCEPT NEW IMAGE
                    img: (false) ? "IMG" : blogData.img,
                    title: document.getElementById("blogTitle").value,
                    description: document.getElementById("blogDescription").value,
                    tags: selectedTags,
                    content: (document.getElementById("blogEditor").value)
                })
            })
        })
    }
    </script>
</body>
</html>